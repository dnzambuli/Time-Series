---
title: "Task 2"
author: "Nzambuli Daniel"
date: "2024-05-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Question

## The following table gives the gross domestic product (GDP) in 100 million for a certain country from 2010 to 2020

| Year    | 2011 | 2012 | 2013 | 2014 | 2015 | 2016 | 2017 | 2018 | 2019 | 2020 |
|---------|------|------|------|------|------|------|------|------|------|------|
| **GDP** | 35   | 37   | 51   | 54   | 62   | 64   | 74   | 71   | 83   | 80   |

### i.) Fit a trend line for GDP data and find trend values with the help of the trend line

```{r}
task_data = data.frame(year = seq(2011, 2020),
                       GDP = c(35, 37, 51, 54, 62, 64, 74, 71, 83, 80))

task_data
```

Using the trend_reg_smooth line generated by zeroing the year data ie

$$
\sum^{2020}_{i = 2011} year_i = 0 
$$

```{r}
med_yr = median(task_data$year)
task_data$zero_yr = task_data$year - med_yr
task_data
```

$$
trend_reg_smooth\ line = \beta_0 + \beta_1 x
$$

$$
\beta_1 = \frac{\sum^{n}_{i = 1}(x_i - \bar{x})(y_i - \bar{y})}{\sum^{n}_{i = 1} (x_i - \bar{x})^2}
$$

$$
\beta_0 = \bar{y} - \beta_1 \bar{x}
$$

```{r}
trend = lm(GDP~zero_yr, data = task_data)
trend$coefficients
```

```{r}
# create the reg_smooth data 
Beta_0 = trend$coefficients[1]
Beta_1 = trend$coefficients[2]

task_data$reg_smooth = Beta_1 * task_data$zero_yr + Beta_0
task_data
```

#### Quadratic Smoothing

```{r}
quad_smth = loess(GDP~zero_yr, task_data)
task_data$quad_smth = predict(quad_smth, task_data)
task_data
```

#### Compare the model for best fit

```{r}
# regressive smoothing
summary(trend)$r.squared
```

```{r}
# quadratic smoothing
mean_GDP = mean(task_data$GDP)
SST = sum((task_data$GDP - mean_GDP)^2)

residuals = residuals(quad_smth)

SSE = sum(residuals^2)

R_squared = 1 - (SSE / SST)

R_squared
```

#### Conclusion

> -   **Model linear smoothing**: R-squared = 0.9485176
>
> -   **Model Quadratic smoothing**: R-squared = 0.963137
>
> **Model Quadratic smoothing** has a higher R-squared value (0.963137) compared to Model linear smoothing (0.9485176). This suggests that Model B explains a higher proportion of the variance in the dependent variable using its predictors than Model A does.

#### Plot the smooth-line

```{r}
library(ggplot2)

ggplot(aes(x = year), data = task_data)+
  geom_line(aes(y = GDP, color = "original"))+
  geom_line(aes(y = reg_smooth, color = "reg_smooth"))+
  geom_line(aes(y = quad_smth, color = "quad_smth"))+
  labs(
    title = "GDP to Year Data",
    x = "year",
    y = "GDP"
  )+
  scale_color_manual(name = "Legend", values = c("original" = "black", "reg_smooth"= "red", "quad_smth"= "blue"))+
  theme_minimal()
```

### ii.) find forecast errors

```{r}
task_data$forecst_err_linear = task_data$GDP - task_data$reg_smooth
task_data$forecst_err_quad = task_data$GDP - task_data$quad_smth


task_data
```

```{r}
cat("The forecast errors are:\n\nYear:", seq(2011, 2019),"\n\nLinear smoothing Err :", task_data$forecst_err_linear, "\n\nQuadratic smoothing Err :", task_data$forecst_err_quad)
```

### iii.) Use best-fit reg_smooth model to predict the country's GDP for 2022

```{r}
new_data = data.frame(zero_yr = 2022 - med_yr)

predicted_gdp = predict(trend, newdata = new_data)
```

```{r}
cat("The GDP for 2022 is predicted to be: ", predicted_gdp, "\n")
```

#### with best fit model

```{r}
loes_val = data.frame(year = seq(2011, 2022),
                      GDP =predict(quad_smth, newdata = data.frame(zero_yr = seq(2011, 2022) - median(seq(2011, 2022)))))
loes_val
```

> **ISSUE IDENTIFIED**\
>
> **loess** local area smoothing in R can not predict outside the scope of the original data meaning adding a new extreme causes the model to introduce `NA` values in order to coerce the data
>
> **How to Solve**
>
> -   fitting a model to the new extended years

```{r}
zero_yr_range  =  seq(min(task_data$zero_yr), max(task_data$zero_yr), length.out = 100)
predicted_values  =  predict(quad_smth, newdata = data.frame(zero_yr = zero_yr_range))

loes_df = data.frame(zero_yr = zero_yr_range, pred = predicted_values)

poly_fit  =  lm(predicted_values ~ zero_yr_range)
coefficients(poly_fit)
```

$$
2022\ prediction = Intercept + poly(zero_yr_range) (2022 - 2015.5) + poly(zero_yr_range) (2022 - 2015.5)^2 
$$

```{r}
Coeffs = coefficients(poly_fit)

loes_n = nrow(task_data)
loes_yt = sum(task_data$GDP)
loes_xt = sum(task_data$zero_yr)
loes_xt_2 = sum(task_data$zero_yr ^ 2)
loes_beta_2 = (loes_yt - (loes_n * Coeffs[1]) - (Coeffs[2] * loes_xt))/ loes_xt_2

cat("The GDP for 2022 is predicted to be: ", Coeffs[1] + (2022 - med_yr) * Coeffs[2] + (2022 - med_yr)^2 * loes_beta_2, "\n")
```

#### Confirm using the formula

$$
formula\ to\ solve\\
\sum y_t = n\beta_0 + \beta_1 \sum x_t + \beta_2 \sum x_t^2\\
\sum x_t y_t = \beta_0 \sum x_t + \beta_1 \sum x_t^2 + \beta_2 \sum x_t^3\\
\sum x_t^2 y_t = \beta_0 \sum x_t^2 + \beta_1 \sum x_t^3 + \beta_2 \sum x_t^4
$$

```{r}
new_data = data.frame(x = task_data$zero_yr,
                      y = task_data$GDP)
new_data$x_sqrd = new_data$x^2
new_data$x_y = new_data$x * new_data$y 
new_data$x_cubed = new_data$x^3
new_data$x_quad = new_data$x^4
new_data$x_2_y = new_data$x_sqrd * new_data$y

new_data
```

```{r}
b = c(sum(new_data$y), sum(new_data$x_y), sum(new_data$x_2_y))

val_1 = sum(new_data$x)
val_2 = sum(new_data$x_sqrd)
val_3 = sum(new_data$x_cubed)
val_4 =  sum(new_data$x_quad)
a = matrix(c(10, val_1, val_2,
           val_1, val_2, val_3,
           val_2, val_3, val_4), byrow = TRUE, nrow = 3)

a
```

```{r}
coef_x = solve(a, b)
coef_x
```

```{r}
cat("The corrected GDP using math formula is:\n\t ", coef_x[1] + (2022 - med_yr) * coef_x[2] + (2022 - med_yr)^2 * coef_x[3])
```

```{r}
task_data$math_quad = coef_x[1] + task_data$zero_yr * coef_x[2] + task_data$zero_yr^2 * coef_x[3]

task_data
```

```{r}
library(ggplot2)

ggplot(aes(x = year), data = task_data)+
  geom_line(aes(y = GDP, color = "original"))+
  geom_line(aes(y = reg_smooth, color = "reg_smooth"))+
  geom_line(aes(y = quad_smth, color = "quad_smth"))+
  labs(
    title = "GDP to Year Data",
    x = "year",
    y = "GDP"
  )+
  scale_color_manual(name = "Legend", values = c("original" = "black", "reg_smooth"= "red", "quad_smth"= "blue"))+
  theme_minimal()
```

> **DISCOVERY**
>
> **Remember** that the best fit model is the **Quadratic model** based on the higher **R-squared value**\
>
> -   using the built in method `loess()` we end up with a predicted value for the year 2022 of
>
>     $$
>     GDP = 94.04349
>     $$
>
> -   using the mathematical formula we end up with a GDP of
>
> $$
> GDP = 85.81818
> $$

## The number of subscribers to a streaming service from 2014 to 2021 is given in the following table: 

| Year                      | 2014 | 2015 | 2016 | 2017 | 2018 | 2019 | 2020 | 2021 |
|---------------------------|------|------|------|------|------|------|------|------|
| Subscribers (in millions) | 2    | 5    | 11   | 20   | 35   | 50   | 70   | 95   |

### i.) Fit the exponential trend

```{r}
exp_data = data.frame(year= seq(2014, 2021),
                      subscribers = c(2, 5, 11, 20, 35, 50, 70, 95))
exp_data
```

#### Model for exponential data

$$
y = \alpha e^{\beta x}
$$

```{r}
exp_Data = function(df,x, y){
  # transform
  log_data = log(df[[y]])
  
  yr = df[[x]]
  
  # fit 
  model = lm(log_data~yr, data = df )
  
  print(paste("model summary:\n", summary(model)))
  
  # intercepts
  alpha = exp(coef(model)[1])
  beta = coef(model)[2]
  
  cat("The alpha value is and the beta value is:\n\t", alpha, "\t", beta,"\n")
  
  val = df[[x]]
  
  predicted = alpha * exp(beta * val)
  
  return(predicted)
  
  
}
```

```{r}
exp_data$t = exp_data$year - median(exp_data$year)
exp_data$exp_trend = exp_Data(exp_data, "t", "subscribers")
```

```{r}
exp_data
```

### ii.) find the forecast errors

```{r}
exp_data$forecst_err = exp_data$subscribers - exp_data$exp_trend

exp_data
```

### iii.) Use the exponential trend model to predict the number of subscribers for 2024.

```{r}
pred_subs = function(alpha, beta, target){
  
  return(alpha * exp(beta * target))
}
```

```{r}
med = median(exp_data$year)
target = 2024 - med
cat("The predicted subsribers are:\n\t",round(pred_subs(20.00024, 0.5395523, target)), "\n")
```

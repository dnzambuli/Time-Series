---
title: "Task 2"
author: "Nzambuli Daniel"
date: "2024-05-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Question

## The following table gives the gross domestic product (GDP) in 100 million for a certain country from 2010 to 2020

| Year    | 2011 | 2012 | 2013 | 2014 | 2015 | 2016 | 2017 | 2018 | 2019 | 2020 |
|---------|------|------|------|------|------|------|------|------|------|------|
| **GDP** | 35   | 37   | 51   | 54   | 62   | 64   | 74   | 71   | 83   | 80   |

### i.) Fit a trend line for GDP data and find trend values with the help of the trend line

```{r}
task_data = data.frame(year = seq(2011, 2020),
                       GDP = c(35, 37, 51, 54, 62, 64, 74, 71, 83, 80))

task_data
```

Using the trend_reg_smooth line generated by zeroing the year data ie

$$
\sum^{2020}_{i = 2011} year_i = 0 
$$

```{r}
med_yr = median(task_data$year)
task_data$zero_yr = task_data$year - med_yr
task_data
```

$$
trend_reg_smooth\ line = \beta_0 + \beta_1 x
$$

$$
\beta_1 = \frac{\sum^{n}_{i = 1}(x_i - \bar{x})(y_i - \bar{y})}{\sum^{n}_{i = 1} (x_i - \bar{x})^2}
$$

$$
\beta_0 = \bar{y} - \beta_1 \bar{x}
$$

```{r}
trend = lm(GDP~zero_yr, data = task_data)
trend$coefficients
```

```{r}
# create the reg_smooth data 
Beta_0 = trend$coefficients[1]
Beta_1 = trend$coefficients[2]

task_data$reg_smooth = Beta_1 * task_data$zero_yr + Beta_0
task_data
```

#### Quadratic Smoothing

```{r}
quad_smth = loess(GDP~zero_yr, task_data)
task_data$quad_smth = predict(quad_smth, task_data)
task_data
```

#### Compare the model for best fit

```{r}
# regressive smoothing
summary(trend)$r.squared
```

```{r}
# quadratic smoothing
mean_GDP = mean(task_data$GDP)
SST = sum((task_data$GDP - mean_GDP)^2)

residuals = residuals(quad_smth)

SSE = sum(residuals^2)

R_squared = 1 - (SSE / SST)

R_squared
```

#### Conclusion

> -   **Model linear smoothing**: R-squared = 0.9485176
>
> -   **Model Quadratic smoothing**: R-squared = 0.963137
>
> **Model Quadratic smoothing** has a higher R-squared value (0.963137) compared to Model linear smoothing (0.9485176). This suggests that Model B explains a higher proportion of the variance in the dependent variable using its predictors than Model A does.

#### Plot the smooth-line

```{r}
library(ggplot2)

ggplot(aes(x = year), data = task_data)+
  geom_line(aes(y = GDP, color = "original"))+
  geom_line(aes(y = reg_smooth, color = "reg_smooth"))+
  geom_line(aes(y = quad_smth, color = "quad_smth"))+
  labs(
    title = "GDP to Year Data",
    x = "year",
    y = "GDP"
  )+
  scale_color_manual(name = "Legend", values = c("original" = "black", "reg_smooth"= "red", "quad_smth"= "blue"))+
  theme_minimal()
```

### ii.) find forecast errors

```{r}
task_data$forecst_err_linear = task_data$GDP - task_data$reg_smooth
task_data$forecst_err_quad = task_data$GDP - task_data$quad_smth


task_data
```

```{r}
cat("The forecast errors are:\n\nYear:", seq(2011, 2019),"\n\nLinear smoothing Err :", task_data$forecst_err_linear, "\n\nQuadratic smoothing Err :", task_data$forecst_err_quad)
```

### iii.) Use best-fit reg_smooth model to predict the country's GDP for 2022

```{r}
new_data = data.frame(zero_yr = 2022 - med_yr)

predicted_gdp = predict(trend, newdata = new_data)
```

```{r}
cat("The GDP for 2022 is predicted to be: ", predicted_gdp, "\n")
```

#### with best fit model

```{r}
loes_val = data.frame(year = seq(2011, 2022),
                      GDP =predict(quad_smth, newdata = data.frame(zero_yr = seq(2011, 2022) - median(seq(2011, 2022)))))
loes_val
```

> **ISSUE IDENTIFIED**\
>
> **loess** local area smoothing in R can not predict outside the scope of the original data meaning adding a new extreme causes the model to introduce `NA` values in order to coerce the data
>
> **How to Solve**
>
> -   fitting a model to the new extended years

```{r}
zero_yr_range  =  seq(min(task_data$zero_yr), max(task_data$zero_yr), length.out = 100)
predicted_values  =  predict(quad_smth, newdata = data.frame(zero_yr = zero_yr_range))

loes_df = data.frame(zero_yr = zero_yr_range, pred = predicted_values)

poly_fit  =  lm(predicted_values ~ zero_yr_range)
coefficients(poly_fit)
```

$$
2022\ prediction = Intercept + poly(zero_yr_range) (2022 - 2015.5) + poly(zero_yr_range) (2022 - 2015.5)^2 
$$

```{r}
Coeffs = coefficients(poly_fit)

loes_n = nrow(task_data)
loes_yt = sum(task_data$GDP)
loes_xt = sum(task_data$zero_yr)
loes_xt_2 = sum(task_data$zero_yr ^ 2)
loes_beta_2 = (loes_yt - (loes_n * Coeffs[1]) - (Coeffs[2] * loes_xt))/ loes_xt_2

cat("The GDP for 2022 is predicted to be: ", Coeffs[1] + (2022 - med_yr) * Coeffs[2] + (2022 - med_yr)^2 * loes_beta_2, "\n")
```

```{r}

task_data$loes_pred =  Coeffs[1] + (task_data$year - med_yr) * Coeffs[2] + (task_data$year - med_yr)^2 * loes_beta_2

task_data
```

#### Confirm using the formula

$$
formula\ to\ solve\\
\sum y_t = n\beta_0 + \beta_1 \sum x_t + \beta_2 \sum x_t^2\\
\sum x_t y_t = \beta_0 \sum x_t + \beta_1 \sum x_t^2 + \beta_2 \sum x_t^3\\
\sum x_t^2 y_t = \beta_0 \sum x_t^2 + \beta_1 \sum x_t^3 + \beta_2 \sum x_t^4
$$

```{r}
new_data = data.frame(x = task_data$zero_yr,
                      y = task_data$GDP)
new_data$x_sqrd = new_data$x^2
new_data$x_y = new_data$x * new_data$y 
new_data$x_cubed = new_data$x^3
new_data$x_quad = new_data$x^4
new_data$x_2_y = new_data$x_sqrd * new_data$y

new_data
```

```{r}
b = c(sum(new_data$y), sum(new_data$x_y), sum(new_data$x_2_y))

val_1 = sum(new_data$x)
val_2 = sum(new_data$x_sqrd)
val_3 = sum(new_data$x_cubed)
val_4 =  sum(new_data$x_quad)
a = matrix(c(10, val_1, val_2,
           val_1, val_2, val_3,
           val_2, val_3, val_4), byrow = TRUE, nrow = 3)

a
```

```{r}
coef_x = solve(a, b)
coef_x
```

```{r}
cat("The corrected GDP using math formula is:\n\t ", coef_x[1] + (2022 - med_yr) * coef_x[2] + (2022 - med_yr)^2 * coef_x[3])
```

```{r}
task_data$math_quad = coef_x[1] + task_data$zero_yr * coef_x[2] + task_data$zero_yr^2 * coef_x[3]

task_data
```

#### plot function

```{r}
library(ggplot2)

plot_smth = function(y_data, col){
  plot_data = data.frame(x = task_data$year,
                         y = task_data[[y_data]])
  plot = ggplot(aes(x = x), data = plot_data)+
    geom_line(aes(y = y, color = col))+
    labs(
    title = "GDP to Year Data",
    x = "year",
    y = "GDP"
  )+
  theme_minimal()
  return(plot)
}
```

```{r}

ggplot(aes(x = year), data = task_data)+
  geom_line(aes(y = GDP, color = "original"))+
  geom_line(aes(y = reg_smooth, color = "reg_smooth"))+
  geom_line(aes(y = quad_smth, color = "quadratic_smth"))+
  geom_line(aes(y = loes_pred, color = "loess_calc_pred"))+
   geom_line(aes(y = math_quad, color = "math_calc_pred"))+
  labs(
    title = "GDP to Year Data",
    x = "year",
    y = "GDP"
  )+
  scale_color_manual(name = "Legend", values = c("original" = "black", "reg_smooth"= "red", "quadratic_smth"= "blue", "loess_calc_pred" = "green", "math_calc_pred" = "orange"))+
  theme_minimal()




```

```{r}
plot_smth("reg_smooth", "red")
```

```{r}
plot_smth("quad_smth", "blue")
```

```{r}
plot_smth("math_quad", "orange")
```

```{r}
plot_smth("loes_pred", "red")
```

> **DISCOVERY**
>
> **Remember** that the best fit model is the **Quadratic model** based on the higher **R-squared value**\
>
> -   using the built in method `loess()` we end up with a predicted value for the year 2022 of close to the prediction of the best fit smoothing
>
>     $$
>     GDP = 94.04349
>     $$
>
> -   using the mathematical formula we end up with a GDP of
>
> $$
> GDP = 85.81818
> $$
>
> **Interpreting the graphs**
>
> 1.  ***red line*** **–** *Least squares smoothing* labeled as `reg smoothing` creates a straight line at the least square difference distance between $\sum err^2 = 0$ the points. This bisects the troughs and peaks of the original trend line
> 2.  ***green line*** **–** *The distance calculated by loess coefficients*labeled as `loes_calc_pred` follows the least squared difference line. However there is a curve to the line which has an increasing gradient when the GDP increases . However during down turns the gradient of the curve decreases. This is a better model for picking up on variation in GDP than Least squares smoothing that only offers the direction of GDP growth.
> 3.  ***blue line –** The quadratic smoothing* It is an angular line that follows the trend line of the original GDP data. However it lacks the steep curves and tries to fit the data depending on the midpoint weight of its neighboring points without losing a lot of information. This low loss of information is reflected in the higher *r-squared* value compared to least square regression. This makes it the **best-fit line**
> 4.  ***orange line*** – The mathematical calculation just creates a smoother version of blue quadratic smoothing line. This improves the accuracy of the quadratic smoothing prediction.
>
> From this: the GDP of $85.82$ is chosen as the most accurate prediction

## The number of subscribers to a streaming service from 2014 to 2021 is given in the following table:

| Year                      | 2014 | 2015 | 2016 | 2017 | 2018 | 2019 | 2020 | 2021 |
|---------------------------|------|------|------|------|------|------|------|------|
| Subscribers (in millions) | 2    | 5    | 11   | 20   | 35   | 50   | 70   | 95   |

### i.) Fit the exponential trend

```{r}
exp_data = data.frame(year= seq(2014, 2021),
                      subscribers = c(2, 5, 11, 20, 35, 50, 70, 95))
exp_data
```

#### Model for exponential data

$$
y = \alpha e^{\beta x}
$$

```{r}
exp_Data = function(df,x, y){
  # transform
  log_data = log(df[[y]])
  
  yr = df[[x]]
  
  # fit 
  model = lm(log_data~yr, data = df )
  
  print("model summary:")
  print(summary(model))
  cat("\n\n\nThe R-squared value is:\n", summary(model)$r.squared)
  
  # intercepts
  alpha = exp(coef(model)[1])
  beta = coef(model)[2]
  
  cat("\n\n\nThe alpha value is and the beta value is:\n\t", alpha, "\t", beta,"\n")
  
  val = df[[x]]
  
  predicted = alpha * exp(beta * val)
  
  return(predicted)
  
  
}
```

```{r}
exp_data$t = exp_data$year - median(exp_data$year)
exp_data$exp_trend = exp_Data(exp_data, "t", "subscribers")
```

```{r}
exp_data
```

### ii.) find the forecast errors

```{r}
exp_data$forecst_err = exp_data$subscribers - exp_data$exp_trend

exp_data
```

### iii.) Use the exponential trend model to predict the number of subscribers for 2024.

```{r}
pred_subs = function(alpha, beta, target){
  
  return(alpha * exp(beta * target))
}
```

```{r}
med = median(exp_data$year)
target = 2024 - med
cat("The predicted subsribers are:\n\t",round(pred_subs(20.00024, 0.5395523, target)), "\n")
```

#### Plotting

```{r}
ggplot(aes(x = year), data = exp_data)+
  geom_point(aes(y = subscribers, color = "original"))+
  geom_line(aes(y = exp_trend, color = "exponential_smth"))+
  labs(
    title = "Exponential Smoothing of Subscriber Data",
    x = "Years",
    y = "subsribers"
  )+
  scale_color_manual(name = "Legend",
                     values = c("original" = "maroon",
                                "exponential_smth" = "purple"))+
  theme_light()
```

#### Prediction plot

```{r}
pred_exp = rbind(data.frame(
  year = c(2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021),
  subscribers = exp_data$exp_trend,
  t = c(-3.5, -2.5, -1.5, -0.5, 0.5, 1.5, 2.5, 3.5)
),
                 data.frame(year = 2024, subscribers = 667, t = 6.5))

ggplot(pred_exp, aes(x = year, y = subscribers)) +
  geom_point(aes(color = year == 2024), size = 4) +  
  geom_line(data = pred_exp[pred_exp$year <= 2021, ], aes(group = 1)) + 
  geom_line() +
  scale_color_manual(values = c("black", "red")) +  
  labs(title = "Subscribers Over the Years with 2024 Prediction",
       x = "Year",
       y = "Subscribers") +
  theme_minimal()
```

# Trying Exponential on GDP

```{r}
task_data$exp_smth = exp_Data(task_data, "zero_yr", "GDP")
```

```{r}
task_data
```

> **Conclusion**
>
> The ranking of the best model for predicting GDP based on R-squared value are
>
> 1.  **Quadratic Smoothing**
> 2.  **Least squares smoothing**
> 3.  **Exponential smoothing**
>
> The initial conclusion that the best predicted value for GDP is $85.82$ still stands.
